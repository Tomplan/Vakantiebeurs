<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; width: 100vw; }
    .rotate-handle { background: red; border-radius: 50%; width: 16px; height: 16px; }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
var map = L.map('map', {
  minZoom: 1,
  maxZoom: 22
}).setView([51.5, -0.09], 19);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  minZoom: 1,
  maxZoom: 22
}).addTo(map);

// Utility: meters <-> lat/lng
function metersToLatLng(centerLatLng, dx, dy) {
  // dx: meters east, dy: meters north
  var R = 6378137; // earth radius in meters
  var dLat = dy / R;
  var dLng = dx / (R * Math.cos(Math.PI * centerLatLng.lat / 180));
  return [
    centerLatLng.lat + dLat * 180 / Math.PI,
    centerLatLng.lng + dLng * 180 / Math.PI
  ];
}

// Rectangle points in meters (relative to center)
function getRectangleCornersMeters(centerLatLng, width_m, height_m, angleDeg) {
  var hw = width_m / 2;
  var hh = height_m / 2;
  var angleRad = angleDeg * Math.PI / 180;
  // Rectangle corners: SW, SE, NE, NW
  var localCorners = [
    [-hw, -hh], // SW
    [ hw, -hh], // SE
    [ hw,  hh], // NE
    [-hw,  hh]  // NW
  ];
  // Rotate and convert to lat/lng
  return localCorners.map(function(p) {
    var x = p[0], y = p[1];
    // Rotate around center
    var xr = x * Math.cos(angleRad) - y * Math.sin(angleRad);
    var yr = x * Math.sin(angleRad) + y * Math.cos(angleRad);
    return metersToLatLng(centerLatLng, xr, yr);
  });
}

// Initial rectangle properties
var center = L.latLng(51.5, -0.09);
var width = 6;    // meters
var height = 6;   // meters
var angle = 0;    // degrees

var corners = getRectangleCornersMeters(center, width, height, angle);
var rect = L.polygon(corners, {color: "blue", weight: 2}).addTo(map);

// Center marker (built-in Leaflet marker)
var centerMarker = L.marker(center, {
  draggable: true
}).addTo(map);

// Rotation handle (NE corner, custom red dot)
var handleMarker = L.marker(corners[2], {
  draggable: true,
  icon: L.divIcon({className: 'rotate-handle', iconSize: [16, 16]})
}).addTo(map);

// Drag center marker to move rectangle (keeps 90Â° corners)
centerMarker.on('drag', function(e) {
  center = e.latlng;
  corners = getRectangleCornersMeters(center, width, height, angle);
  rect.setLatLngs(corners);
  handleMarker.setLatLng(corners[2]);
});

// Drag rotation handle to rotate rectangle
handleMarker.on('drag', function(e) {
  var handleLatLng = e.latlng;
  // Compute angle between center and handle (ignore Earth's curvature for small distances)
  var dx = (handleLatLng.lng - center.lng) * Math.cos(center.lat * Math.PI / 180) * 111320;
  var dy = (handleLatLng.lat - center.lat) * 111320;
  var newAngle = Math.atan2(dy, dx) * 180 / Math.PI - 45;
  angle = newAngle;
  corners = getRectangleCornersMeters(center, width, height, angle);
  rect.setLatLngs(corners);
  handleMarker.setLatLng(corners[2]);
});

centerMarker.on('dragend', function() {
  handleMarker.setLatLng(getRectangleCornersMeters(center, width, height, angle)[2]);
});
handleMarker.on('dragend', function() {
  handleMarker.setLatLng(getRectangleCornersMeters(center, width, height, angle)[2]);
});
</script>
</body>
</html>
